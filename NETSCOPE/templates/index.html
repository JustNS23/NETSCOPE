<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NETSCOPE - Cyber Audit</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- TH√àME SOMBRE --- */
        :root {
            --bg-dark: #0b1116; --panel-dark: #161b22; --border-color: #30363d;
            --accent-cyan: #00f2ea; --text-main: #c9d1d9; --text-muted: #8b949e;
            --danger: #ff3e3e; --success: #2ea043; --warning: #f1c40f;
            --udp-color: #9b59b6;
        }

        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 20px; }
        h1, h2, h3, h4 { font-family: 'JetBrains Mono', monospace; text-transform: uppercase; margin: 0; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand h1 { font-size: 24px; color: #fff; letter-spacing: 2px; }
        .brand span { color: var(--accent-cyan); }
        .logo-img { height: 40px; }

        .nav-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; gap: 5px; }
        .nav-item { padding: 10px 20px; cursor: pointer; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; border-bottom: 2px solid transparent; transition: all 0.3s ease; text-transform: uppercase; font-size: 14px; }
        .nav-item:hover { color: #fff; background-color: rgba(255,255,255,0.02); }
        .nav-item.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); text-shadow: 0 0 8px rgba(0, 242, 234, 0.4); }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .cyber-card { background-color: var(--panel-dark); border: 1px solid var(--border-color); border-radius: 6px; padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden; }
        .card-title { color: var(--accent-cyan); font-size: 14px; margin-bottom: 15px; padding-left: 10px; border-left: 3px solid var(--accent-cyan); letter-spacing: 1px; }

        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: end; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
        
        label { display: block; color: var(--text-muted); font-size: 12px; margin-bottom: 8px; font-family: 'JetBrains Mono', monospace; }
        input, select, textarea { width: 100%; background-color: #0d1117; border: 1px solid var(--border-color); color: #fff; padding: 10px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; box-sizing: border-box; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-cyan); }

        .btn-cyber { background: linear-gradient(45deg, #00b4d8, var(--accent-cyan)); color: #000; border: none; padding: 12px 25px; font-weight: bold; font-family: 'JetBrains Mono', monospace; cursor: pointer; text-transform: uppercase; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); transition: all 0.2s; width: 100%; }
        .btn-cyber:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); padding: 8px 15px; border-radius: 4px; cursor: pointer; text-transform: uppercase; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        .btn-outline:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }

        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 32px; font-weight: bold; color: #fff; }
        .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; }

        .score-bar-container { width: 100%; background-color: #0d1117; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .score-bar-fill { height: 100%; background: var(--accent-cyan); width: 0%; transition: width 1s ease; box-shadow: 0 0 10px var(--accent-cyan); }
        
        .top-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .stat-row { margin-bottom: 12px; }
        .stat-info { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; color: var(--text-main); }
        .stat-bar-bg { width: 100%; background: #0d1117; height: 6px; border-radius: 3px; overflow: hidden; }
        .stat-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .sub-title { color: #fff; font-size: 12px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; }

        .table-wrapper { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background-color: #1c2128; color: var(--text-muted); text-align: left; padding: 10px; border-bottom: 2px solid var(--border-color); vertical-align: top; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        tr:hover td { background-color: #1c2128; }

        .th-sort { cursor: pointer; display: flex; align-items: center; gap: 5px; margin-bottom: 5px; user-select: none; }
        .th-sort:hover { color: var(--accent-cyan); }
        .col-filter { width: 100%; padding: 4px; background: #0d1117; border: 1px solid #30363d; color: #fff; font-size: 11px; border-radius: 3px; margin-top: 2px; box-sizing: border-box; }
        .col-filter:focus { border-color: var(--accent-cyan); outline: none; }

        .badge { padding: 3px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; }
        .badge-tcp { border: 1px solid var(--accent-cyan); color: var(--accent-cyan); }
        .badge-http { border: 1px solid var(--danger); color: var(--danger); }
        .badge-https { border: 1px solid var(--success); color: var(--success); }
        .badge-udp { border: 1px solid var(--udp-color); color: var(--udp-color); }
        .badge-dns { border: 1px solid var(--warning); color: var(--warning); }
        .badge-other { border: 1px solid var(--text-muted); color: var(--text-muted); }
        .badge-count { background: var(--danger); color: #fff; border-radius: 10px; padding: 2px 6px; font-size: 10px; margin-left: 5px; vertical-align: middle; }
        .count-tag { background: #30363d; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 10px; color: #fff; }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--panel-dark); margin: 5% auto; padding: 0; border: 1px solid var(--accent-cyan); width: 80%; max-width: 900px; border-radius: 6px; box-shadow: 0 0 30px rgba(0, 242, 234, 0.2); }
        .modal-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        .layer-title { color: var(--accent-cyan); border-bottom: 1px solid #333; margin-top: 10px; display: block; }
        .detail-row { display: flex; border-bottom: 1px solid #333; padding: 4px 0; }
        .detail-key { width: 30%; color: #888; }
        .close-btn { font-size: 24px; cursor: pointer; color: white; }

        .hidden { display: none !important; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .checkbox-wrapper input { width: auto; margin: 0; }
        .time-cell { color: #fff; font-weight: bold; font-family: 'JetBrains Mono', monospace; }
        
        .pagination-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); color: var(--text-muted); font-size: 12px; }
        .loader-bar-container { width: 100%; height: 8px; background: #0d1117; border-radius: 4px; overflow: hidden; margin-top: 15px; }
        .loader-bar-fill { height: 100%; background: var(--accent-cyan); width: 0%; box-shadow: 0 0 10px var(--accent-cyan); transition: width 0.1s linear; }

        #sankey-container-wrapper { overflow: hidden; max-width: 100%; }
        #sankeyChart { width: 100% !important; height: 500px !important; overflow: hidden; }
        .input-misp { background:#1c2128; border:1px solid #30363d; color:#fff; font-size:12px; font-family:monospace; margin-bottom:5px; }
    </style>
</head>
<body>

    <div class="header-bar">
        <div class="brand">
            <img src="/static/logo.png" alt="Logo" class="logo-img" id="mainLogo" onerror="this.style.display='none'">
            <h1>NET<span>SCOPE</span></h1>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 12px; color: var(--text-muted);">STATUT SYST√àME</div>
            <div style="color: var(--success);">‚óè ONLINE</div>
        </div>
    </div>

    <!-- TABS -->
    <div class="nav-tabs">
        <div class="nav-item active" onclick="switchTab('dashboard')">DASHBOARD</div>
        <div class="nav-item" onclick="switchTab('anomalies')">ANOMALIES <span id="badge-anom" class="badge-count hidden">0</span></div>
        <div class="nav-item" onclick="switchTab('jobs')">HISTORIQUE</div>
        <div class="nav-item" onclick="switchTab('admin')">ADMINISTRATION</div>
    </div>

    <!-- 1. DASHBOARD -->
    <div id="tab-dashboard" class="tab-content active">
        <div class="cyber-card">
            <h3 class="card-title">CONFIGURATION AUDIT</h3>
            <div class="config-grid">
                <div>
                    <label>INTERFACE</label>
                    <select id="interfaceSelect"><option>Chargement...</option></select>
                </div>
                <div>
                    <label>DUR√âE (S)</label>
                    <input type="number" id="duree" value="10" min="5" max="300">
                </div>
                <div>
                    <label>FILTRES RAPIDES</label>
                    <select onchange="if(this.value) document.getElementById('rawFilter').value=this.value">
                        <option value="">Aucun</option>
                        <option value="tcp.port == 80">Web HTTP (80)</option>
                        <option value="tcp.port == 443">Web HTTPS (443)</option>
                        <option value="!dns">Sans DNS</option>
                        <option value="http.request.method == &quot;POST&quot;">Requ√™tes POST</option>
                        <option value="tcp.analysis.flags">Erreurs TCP</option>
                        <option value="arp">ARP</option>
                        <option value="icmp">Ping (ICMP)</option>
                    </select>
                </div>
                <div>
                    <label>FILTRE BPF</label>
                    <input type="text" id="rawFilter" placeholder="ex: ip.addr == 192.168.1.15">
                </div>
                <div>
                    <button onclick="lancerScan()" class="btn-cyber">LANCER SCAN</button>
                </div>
            </div>

            <div style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; display:flex; gap:20px; align-items:end;">
                <div style="flex:1;">
                    <label style="color:#e67e22;">WEBHOOK N8N</label>
                    <input type="text" id="n8nWebhookUrl" placeholder="https://..." style="border-color:#e67e22;">
                </div>
                <label class="checkbox-wrapper" style="padding-bottom:12px;">
                    <input type="checkbox" id="checkAutoN8N">
                    <span style="color:var(--text-main);">Envoi Automatique</span>
                </label>
            </div>
        </div>

        <div id="loader" class="hidden" style="text-align:center; padding:40px;">
            <h2 style="color:var(--accent-cyan); animation:pulse 1s infinite;">ANALYSE EN COURS...</h2>
            <div class="loader-bar-container"><div id="loaderBar" class="loader-bar-fill"></div></div>
            <p style="color:var(--text-muted); margin-top:15px; font-size:12px;">Capture et traitement des paquets...</p>
        </div>

        <div id="resultats" class="hidden">
            <div class="stats-grid">
                <div class="cyber-card stat-item"><div class="stat-value" id="disp_paquets">0</div><div class="stat-label">Paquets</div></div>
                <div class="cyber-card stat-item"><div class="stat-value" id="disp_ips">0</div><div class="stat-label">IPs</div></div>
                <div class="cyber-card stat-item"><div class="stat-value" id="disp_alertes" style="color:var(--danger)">0</div><div class="stat-label">Alertes</div></div>
                <div class="cyber-card stat-item"><div class="stat-value" id="scoreDisplay">--</div><div class="stat-label">Score</div></div>
            </div>

            <div class="cyber-card">
                <h3 class="card-title">SANT√â R√âSEAU</h3>
                <div class="score-bar-container"><div id="scoreBar" class="score-bar-fill"></div></div>
                <div id="listeAlertes" style="margin-top:10px; font-size:13px;"></div>
            </div>

            <!-- TOP STATS -->
            <div class="cyber-card">
                <h3 class="card-title">TOP TALKERS & SERVICES</h3>
                <div class="top-stats-grid">
                    <div>
                        <h4 class="sub-title">TOP SOURCES (IP)</h4>
                        <div id="top-ips-container"></div>
                    </div>
                    <div>
                        <h4 class="sub-title">TOP SERVICES / PORTS</h4>
                        <div id="top-ports-container"></div>
                    </div>
                </div>
            </div>

            <!-- SANKEY -->
            <div id="sankey-container-wrapper" class="cyber-card hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; margin-bottom:15px;">
                    <h3 class="card-title" style="margin:0; border:none; padding:0;">VISUALISATION DES FLUX (SANKEY)</h3>
                    <!-- NOUVEAU SWITCH POUR LES NOMS -->
                    <label class="checkbox-wrapper" style="margin:0; color:var(--text-muted); font-size:12px;">
                        <input type="checkbox" id="chkShowNames" onchange="renderSankey(TOUT_LE_TRAFIC)">
                        <span>Afficher Noms/Constructeurs</span>
                    </label>
                </div>
                <div id="sankeyChart"></div>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:20px;">
                <button onclick="envoyerVersN8N()" class="btn-outline">üöÄ FORCER N8N</button>
                <button onclick="genererRapportPDF()" class="btn-outline">üìÑ RAPPORT PDF</button>
                <a id="btnDownload" href="#" class="hidden btn-outline" style="text-decoration:none;">üíæ T√âL√âCHARGER .PCAP</a>
            </div>

            <div class="cyber-card">
                <h3 class="card-title">JOURNAL DES FLUX</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:50px;"></th>
                                <th><div class="th-sort" onclick="trierPar('heure')">HEURE <span>‚áÖ</span></div></th>
                                <th><div class="th-sort" onclick="trierPar('service')">SERVICE <span>‚áÖ</span></div><input type="text" class="col-filter" placeholder="Filtre..." onkeyup="filterCol(this, 'service')"></th>
                                <th><div class="th-sort" onclick="trierPar('src')">IP SOURCE <span>‚áÖ</span></div><input type="text" class="col-filter" placeholder="192..." onkeyup="filterCol(this, 'src')"></th>
                                <th><div class="th-sort" onclick="trierPar('mac')">MAC <span>‚áÖ</span></div><input type="text" class="col-filter" placeholder="aa:bb..." onkeyup="filterCol(this, 'mac')"></th>
                                <th><div class="th-sort" onclick="trierPar('vendor')">APPAREIL <span>‚áÖ</span></div><input type="text" class="col-filter" placeholder="Nom..." onkeyup="filterCol(this, 'vendor')"></th>
                                <th><div class="th-sort" onclick="trierPar('dst')">DESTINATION <span>‚áÖ</span></div><input type="text" class="col-filter" placeholder="IP Dest..." onkeyup="filterCol(this, 'dst')"></th>
                                <th><div class="th-sort" onclick="trierPar('proto')">PROTO <span>‚áÖ</span></div><input type="text" class="col-filter" placeholder="TCP..." onkeyup="filterCol(this, 'proto')"></th>
                                <th>INFO</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                
                <div class="pagination-bar">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>Afficher</span>
                        <select id="rowsPerPage" onchange="changerTaillePage()" style="background:#0d1117; color:#fff; border:1px solid #30363d; padding:4px; border-radius:4px;">
                            <option value="10">10</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                        <span>lignes</span>
                    </div>

                    <div style="display:flex; align-items:center; gap:10px;">
                        <button onclick="changerPage(-1)" class="btn-outline" style="padding:4px 10px;">‚ùÆ</button>
                        <span>Page</span>
                        <input type="number" id="pageInput" value="1" min="1" onchange="goToPage(this.value)" 
                               style="width:50px; text-align:center; padding:4px; background:#0d1117; color:#fff; border:1px solid #30363d; border-radius:4px;">
                        <span id="totalPages">/ 1</span>
                        <button onclick="changerPage(1)" class="btn-outline" style="padding:4px 10px;">‚ùØ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. ANOMALIES -->
    <div id="tab-anomalies" class="tab-content">
        <div class="cyber-card" style="border-color: var(--danger);">
            <h3 class="card-title" style="color:var(--danger); border-color:var(--danger);">‚ö†Ô∏è MENACES D√âTECT√âES</h3>
            <div id="listeAlertesFull"><div style="text-align:center; padding:30px; color:var(--text-muted);">Aucune donn√©e disponible.</div></div>
        </div>
    </div>

    <!-- 3. JOBS -->
    <div id="tab-jobs" class="tab-content">
        <div class="cyber-card">
            <h3 class="card-title">HISTORIQUE DES SCANS</h3>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>DATE</th><th>INTERFACE</th><th>DUR√âE</th><th>SCORE</th><th>PAQUETS</th><th>ACTIONS</th></tr></thead>
                    <tbody id="jobsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 4. ADMIN -->
    <div id="tab-admin" class="tab-content">
        <div class="admin-grid">
            <div class="cyber-card">
                <h3 class="card-title">PARAM√àTRES SYST√àME</h3>
                <div style="margin-bottom: 20px;">
                    <label class="checkbox-wrapper" style="color:var(--accent-cyan);">
                        <input type="checkbox" id="chkHighPerf">
                        <span>Capture Haute Performance (AF_PACKET)</span>
                    </label>
                    <p style="font-size:0.8em; color:var(--text-muted); margin-left:25px;">Recommand√© pour les liens 10Gbps+. Utilise un tampon m√©moire √©largi.</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label class="checkbox-wrapper" style="color:#9b59b6;">
                        <input type="checkbox" id="chkTLS">
                        <span>Analyse Chiffr√©e (JA3 & X509)</span>
                    </label>
                    <p style="font-size:0.8em; color:var(--text-muted); margin-left:25px;">Extrait les empreintes TLS et certificats.</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label class="checkbox-wrapper" style="color:#f1c40f;">
                        <input type="checkbox" id="chkAI">
                        <span>Analyse IA (Isolation Forest)</span>
                    </label>
                    <p style="font-size:0.8em; color:var(--text-muted); margin-left:25px;">D√©tection d'anomalies statistiques via Machine Learning.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label class="checkbox-wrapper" style="color:#2ea043;">
                        <input type="checkbox" id="chkVisu">
                        <span>Visualisation des Flux (Sankey)</span>
                    </label>
                    <p style="font-size:0.8em; color:var(--text-muted); margin-left:25px;">Active le diagramme de flux interactif.</p>
                </div>
                
                <div style="margin-bottom: 20px; border-top:1px solid #333; padding-top:10px;">
                    <label class="checkbox-wrapper" style="color:#ff3e3e;">
                        <input type="checkbox" id="chkThreatIntel" onchange="document.getElementById('misp-config').classList.toggle('hidden', !this.checked)">
                        <span>Int√©gration Threat Intel (MISP)</span>
                    </label>
                    <div id="misp-config" class="hidden" style="margin-left:25px; margin-top:10px;">
                        <input type="text" id="mispUrl" class="input-misp" placeholder="URL MISP (ex: https://misp.local)">
                        <input type="password" id="mispKey" class="input-misp" placeholder="Cl√© API">
                    </div>
                </div>

                <div style="text-align:right;">
                    <button class="btn-outline" onclick="saveAdminSettings()" style="border-color:var(--accent-cyan); color:var(--accent-cyan);">üíæ APPLIQUER</button>
                </div>
            </div>

            <div class="cyber-card">
                <h3 class="card-title">GOUVERNANCE</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div>
                        <label style="color:#2ea043; display:flex; justify-content:space-between;">WHITELIST <span id="count-white" class="count-tag">0</span></label>
                        <textarea id="whitelistInput" rows="8" placeholder="192.168.1.1"></textarea>
                    </div>
                    <div>
                        <label style="color:#ff3e3e; display:flex; justify-content:space-between;">BLACKLIST <span id="count-black" class="count-tag">0</span></label>
                        <textarea id="blacklistInput" rows="8" placeholder="185.15.22.1"></textarea>
                    </div>
                </div>
                <div style="text-align:right; margin-top:20px;">
                    <button class="btn-outline" onclick="saveAdminLists()" style="border-color:#2ea043; color:#2ea043;">üíæ SAUVEGARDER LISTES</button>
                </div>
            </div>
        </div>

        <div class="cyber-card">
            <h3 class="card-title">MAINTENANCE</h3>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <p style="font-size:0.9em;">Suppression des fichiers temporaires.</p>
                <button class="btn-cyber" style="width:auto; background:var(--danger); color:#fff;" onclick="clearAllHistory()">üî• PURGER HISTORIQUE</button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 style="color:#fff;">D√âTAILS PAQUET</h3><span class="close-btn" onclick="document.getElementById('detailModal').style.display='none'">&times;</span></div>
            <div class="modal-body" id="modalContent"></div>
        </div>
    </div>

    <script>
        let TOUT_LE_TRAFIC = [], TRAFIC_FILTRE = [], pageActuelle = 1, lignesParPage = 50, timerInterval;
        let activeFilters = { src: "", dst: "", proto: "", service: "", mac: "", vendor: "", info: "" };
        let currentSort = { col: null, asc: true };

        function safeSetText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            const items = document.querySelectorAll('.nav-item');
            if(tabId === 'dashboard') items[0].classList.add('active');
            if(tabId === 'anomalies') items[1].classList.add('active');
            if(tabId === 'jobs') { items[2].classList.add('active'); loadHistory(); }
            if(tabId === 'admin') { items[3].classList.add('active'); loadAdminLists(); loadAdminSettings(); }
        }

        async function loadAdminSettings() {
            if (!window.location.origin || window.location.protocol === 'file:') return;
            try {
                const res = await fetch('/api/admin/settings');
                if(!res.ok) return;
                const data = await res.json();
                if(document.getElementById('chkHighPerf')) document.getElementById('chkHighPerf').checked = data.high_perf;
                if(document.getElementById('chkTLS')) document.getElementById('chkTLS').checked = data.tls_analysis;
                if(document.getElementById('chkAI')) document.getElementById('chkAI').checked = data.ai_analysis;
                if(document.getElementById('chkVisu')) document.getElementById('chkVisu').checked = data.visu_sankey;
                if(document.getElementById('chkThreatIntel')) {
                    document.getElementById('chkThreatIntel').checked = data.threat_intel;
                    if(data.threat_intel) document.getElementById('misp-config').classList.remove('hidden');
                }
                if(document.getElementById('mispUrl')) document.getElementById('mispUrl').value = data.misp_url || "";
                if(document.getElementById('mispKey')) document.getElementById('mispKey').value = data.misp_key || "";
            } catch(e) {}
        }
        async function saveAdminSettings() {
            const data = {
                high_perf: document.getElementById('chkHighPerf').checked,
                tls_analysis: document.getElementById('chkTLS').checked,
                ai_analysis: document.getElementById('chkAI').checked,
                visu_sankey: document.getElementById('chkVisu').checked,
                threat_intel: document.getElementById('chkThreatIntel').checked,
                misp_url: document.getElementById('mispUrl').value,
                misp_key: document.getElementById('mispKey').value
            };
            try { await fetch('/api/admin/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) }); alert("Param√®tres sauvegard√©s"); } catch(e) { alert("Erreur"); }
        }

        async function loadAdminLists() {
            if (!window.location.origin || window.location.protocol === 'file:') return;
            try {
                const res = await fetch('/api/admin/lists');
                if(!res.ok) return;
                const data = await res.json();
                document.getElementById('whitelistInput').value = (data.whitelist||[]).join('\n');
                document.getElementById('blacklistInput').value = (data.blacklist||[]).join('\n');
                updateCount('white'); updateCount('black');
            } catch(e) {}
        }
        async function saveAdminLists() {
            const w = document.getElementById('whitelistInput').value.split('\n');
            const b = document.getElementById('blacklistInput').value.split('\n');
            try { await fetch('/api/admin/lists', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({whitelist:w, blacklist:b}) }); alert("Sauvegard√© !"); } catch(e) { alert("Erreur sauvegarde"); }
        }
        function updateCount(type) {
            const el = document.getElementById(type + 'listInput');
            if(!el) return;
            const count = el.value.split('\n').filter(l => l.trim() !== '').length;
            safeSetText('count-' + type, count);
        }

        async function loadHistory() {
            try {
                const res = await fetch('/api/history');
                const history = await res.json();
                const tbody = document.getElementById('jobsTableBody');
                if(tbody) {
                    tbody.innerHTML = history.length ? "" : "<tr><td colspan='6' style='text-align:center'>Aucun historique</td></tr>";
                    history.forEach(job => {
                        tbody.innerHTML += `<tr><td>${job.date}</td><td>${job.interface}</td><td>${job.duration}s</td><td><span style="color:${job.score>80?'var(--success)':(job.score>50?'orange':'var(--danger)')}">${job.score}</span></td><td>${job.paquets}</td><td><button class="btn-outline" onclick="loadJob('${job.id}')">üëÅÔ∏è REVOIR</button></td></tr>`;
                    });
                }
            } catch(e) {}
        }
        async function loadJob(id) {
            if(!confirm("Charger ce rapport ?")) return;
            try {
                document.getElementById('loader').classList.remove('hidden');
                switchTab('dashboard');
                const res = await fetch('/api/history/' + id);
                const json = await res.json();
                updateDashboard(json.data, json.meta.pcap_file);
            } catch(e) { alert("Erreur: " + e); }
            finally { document.getElementById('loader').classList.add('hidden'); }
        }
        async function clearAllHistory() {
            if(confirm("Tout supprimer ?")) { await fetch('/api/history/clear', {method:'POST'}); alert("Nettoy√©."); loadHistory(); }
        }

        window.onload = async function() {
            if (!window.location.origin || window.location.protocol === 'file:') {
                const sel = document.getElementById('interfaceSelect'); sel.innerHTML = ""; sel.add(new Option("Mode Aper√ßu", "")); return;
            }
            try {
                const r = await fetch('/api/interfaces');
                const ifs = await r.json();
                const sel = document.getElementById('interfaceSelect');
                sel.innerHTML = "";
                ifs.forEach(i => sel.add(new Option(i.name, i.id)));
                loadAdminSettings();
            } catch(e) {}
        };

        async function lancerScan() {
            const iface = document.getElementById('interfaceSelect').value;
            if(!iface) { alert("Interface?"); return; }
            
            switchTab('dashboard');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('resultats').classList.add('hidden');
            document.getElementById('sankey-container-wrapper').classList.add('hidden');
            
            let timeLeft = parseInt(document.getElementById('duree').value);
            safeSetText('countdown', timeLeft);
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                if(timeLeft>=0) safeSetText('countdown', timeLeft);
                else clearInterval(timerInterval);
            }, 1000);
            
            const bar = document.getElementById('loaderBar');
            if(bar) bar.style.width = "0%";
            let startTime = Date.now();
            let durationMs = timeLeft * 1000;
            const barInterval = setInterval(() => {
                let elapsed = Date.now() - startTime;
                let pct = Math.min((elapsed / durationMs) * 100, 100);
                if(bar) bar.style.width = pct + "%";
                if(elapsed >= durationMs) clearInterval(barInterval);
            }, 100);

            const fd = new FormData();
            fd.append('duree', document.getElementById('duree').value);
            fd.append('interface', iface);
            const rf = document.getElementById('rawFilter');
            if(rf && rf.value) fd.append('raw_filter', rf.value);
            
            const hp = document.getElementById('chkHighPerf');
            if(hp && hp.checked) fd.append('high_perf', 'true');
            const tls = document.getElementById('chkTLS');
            if(tls && tls.checked) fd.append('tls_analysis', 'true');
            const ia = document.getElementById('chkAI');
            if(ia && ia.checked) fd.append('ai_analysis', 'true');
            fd.append('fingerprint', 'true');

            try {
                const res = await fetch('/scan', {method:'POST', body:fd});
                const json = await res.json();
                if(json.status === 'success') {
                    updateDashboard(json.data, json.pcap_file);
                    const visu = document.getElementById('chkVisu');
                    if(visu && visu.checked) renderSankey(json.data.details_trafic);
                    const chk = document.getElementById('checkAutoN8N');
                    if(chk && chk.checked) envoyerVersN8N(true);
                } else { alert("Erreur: " + json.message); }
            } catch(e) { console.error(e); alert("Erreur technique"); } 
            finally { 
                clearInterval(timerInterval);
                if(bar) bar.style.width = "100%";
                setTimeout(() => document.getElementById('loader').classList.add('hidden'), 500); 
            }
        }

        function updateDashboard(data, pcapFile) {
            if(!data) return;
            TOUT_LE_TRAFIC = data.details_trafic || [];
            
            safeSetText('disp_paquets', data.total_paquets);
            safeSetText('disp_ips', new Set(TOUT_LE_TRAFIC.map(p => p.src)).size);
            safeSetText('disp_alertes', data.alertes_securite.length);
            safeSetText('scoreDisplay', data.score_global + "/100");

            const bar = document.getElementById('scoreBar');
            if(bar) {
                bar.style.width = data.score_global + "%";
                bar.style.backgroundColor = data.score_global > 80 ? "var(--success)" : (data.score_global > 50 ? "orange" : "var(--danger)");
            }

            // Top Stats
            const ipCounts = {}, svcCounts = {};
            TOUT_LE_TRAFIC.forEach(p => {
                ipCounts[p.src] = (ipCounts[p.src] || 0) + 1;
                const svc = p.service && p.service !== '-' ? p.service : p.proto;
                svcCounts[svc] = (svcCounts[svc] || 0) + 1;
            });
            const renderBars = (counts, containerId, color) => {
                const container = document.getElementById(containerId);
                if(!container) return;
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
                const html = sorted.map(([key, count]) => {
                    const pct = ((count / TOUT_LE_TRAFIC.length) * 100).toFixed(1);
                    return `<div class="stat-row"><div class="stat-info"><span>${key}</span><span>${count} (${pct}%)</span></div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%; background:${color}"></div></div></div>`;
                }).join('');
                container.innerHTML = html || "<div style='color:#666'>Aucune donn√©e</div>";
            };
            renderBars(ipCounts, 'top-ips-container', 'var(--accent-cyan)');
            renderBars(svcCounts, 'top-ports-container', 'var(--warning)');

            // Alertes
            let extraAlerts = [];
            TOUT_LE_TRAFIC.forEach(p => {
                if (p.proto === "HTTP" && p.info && p.info.includes("POST")) {
                    if (!data.alertes_securite.some(a => a.includes("POST"))) extraAlerts.push("Activit√© Suspecte : Requ√™te POST d√©tect√©e");
                }
            });
            const allAlerts = [...data.alertes_securite, ...extraAlerts];
            const alerteHTML = allAlerts.length === 0 
                ? "<div style='color:var(--success); border:1px solid var(--success); padding:10px;'>‚úÖ Aucune menace d√©tect√©e.</div>" 
                : allAlerts.map(a => `<div style='color:var(--danger); background:rgba(255, 62, 62, 0.1); padding:10px; margin-bottom:5px; border-left:4px solid var(--danger);'>‚ö†Ô∏è ${a}</div>`).join('');
            
            const l1 = document.getElementById('listeAlertes'); if(l1) l1.innerHTML = alerteHTML;
            const l2 = document.getElementById('listeAlertesFull'); if(l2) l2.innerHTML = alerteHTML;
            
            const badge = document.getElementById('badge-anom');
            if(badge) {
                badge.innerText = allAlerts.length;
                badge.classList.remove('hidden');
                if(allAlerts.length>0) badge.style.backgroundColor="var(--danger)";
            }

            const btnDl = document.getElementById('btnDownload');
            if(btnDl) {
                if(pcapFile) { btnDl.href = "/download/" + pcapFile; btnDl.classList.remove('hidden'); btnDl.style.display = "inline-flex"; }
                else { btnDl.style.display = "none"; }
            }

            document.getElementById('resultats').classList.remove('hidden');
            appliquerFiltresLocaux();
        }

        // --- SANKEY (AVEC TOGGLE) ---
        function renderSankey(data) {
            const flows = {};
            const showNames = document.getElementById('chkShowNames') ? document.getElementById('chkShowNames').checked : false;

            data.forEach(p => {
                if(!p.src || !p.dst) return;
                
                // --- LOGIQUE D'ENRICHISSEMENT ---
                let srcLabel = p.src;
                let dstLabel = p.dst;
                
                if (showNames) {
                    if (p.vendor && p.vendor !== "Inconnu") srcLabel += ` (${p.vendor})`;
                    // On essaie d'afficher le service si dispo pour la destination
                    if (p.service && p.service !== "-" && !["TCP", "UDP", "HTTPS", "HTTP"].includes(p.service)) {
                        dstLabel += ` (${p.service})`;
                    }
                }
                
                let size = 1;
                if(p.layers && p.layers.frame && p.layers.frame["frame.len"]) size = parseInt(p.layers.frame["frame.len"]);
                
                const label = srcLabel + " -> " + dstLabel;
                flows[label] = (flows[label] || 0) + size;
            });

            const sortedFlows = Object.entries(flows).sort((a, b) => b[1] - a[1]).slice(0, 20);
            if (sortedFlows.length === 0) return;

            document.getElementById('sankey-container-wrapper').classList.remove('hidden');

            const sources = [], targets = [], values = [], labels = [], nodeMap = {};
            sortedFlows.forEach(([key, val]) => {
                const [src, dst] = key.split(" -> ");
                if (!(src in nodeMap)) { nodeMap[src] = labels.length; labels.push(src); }
                if (!(dst in nodeMap)) { nodeMap[dst] = labels.length; labels.push(dst); }
                sources.push(nodeMap[src]); targets.push(nodeMap[dst]); values.push(val);
            });

            const dataTrace = {
                type: "sankey", orientation: "h",
                node: { pad: 20, thickness: 20, line: { color: "#00f2ea", width: 0.5 }, label: labels, color: labels.map(() => "#00f2ea") },
                link: { source: sources, target: targets, value: values, color: sources.map(() => "rgba(0, 242, 234, 0.2)") },
                textfont: { family: "Roboto", size: 12, color: "white" }
            };
            const layout = { font: { size: 12, color: "white" }, paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)", margin: { l: 10, r: 10, t: 30, b: 10 }, height: 500 };
            Plotly.newPlot('sankeyChart', [dataTrace], layout, {displayModeBar: false, responsive: true});
        }

        // --- FILTRES & TRI ---
        function filterCol(input, col) {
            activeFilters[col] = input.value.toLowerCase();
            appliquerFiltresLocaux();
        }

        function appliquerFiltresLocaux() {
            TRAFIC_FILTRE = TOUT_LE_TRAFIC.filter(p => {
                let match = true;
                for (let key in activeFilters) {
                    if (activeFilters[key]) {
                        let val = p[key] ? String(p[key]).toLowerCase() : "";
                        if (!val.includes(activeFilters[key])) return false;
                    }
                }
                return true;
            });
            
            if(currentSort.col) {
                TRAFIC_FILTRE.sort((a,b) => {
                    let va = a[currentSort.col] || "", vb = b[currentSort.col] || "";
                    if(va < vb) return currentSort.asc ? -1 : 1;
                    if(va > vb) return currentSort.asc ? 1 : -1;
                    return 0;
                });
            }
            pageActuelle = 1;
            renderTable();
        }

        function trierPar(col) {
            if(currentSort.col === col) currentSort.asc = !currentSort.asc;
            else { currentSort.col = col; currentSort.asc = true; }
            appliquerFiltresLocaux();
        }

        function goToPage(num) {
            num = parseInt(num);
            const maxPages = Math.ceil(TRAFIC_FILTRE.length/lignesParPage) || 1;
            if (num < 1) num = 1;
            if (num > maxPages) num = maxPages;
            pageActuelle = num;
            renderTable();
        }

        function changerPage(d) {
            const max = Math.ceil(TRAFIC_FILTRE.length / lignesParPage) || 1;
            const next = pageActuelle + d;
            if(next >= 1 && next <= max) { pageActuelle = next; renderTable(); }
        }

        function changerTaillePage() {
            const el = document.getElementById('rowsPerPage');
            if(el) lignesParPage = parseInt(el.value);
            pageActuelle = 1;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            if(!tbody) return;
            tbody.innerHTML = "";
            const start = (pageActuelle - 1) * lignesParPage;
            const data = TRAFIC_FILTRE.slice(start, start + lignesParPage);
            
            safeSetText('pageInfo', `Page ${pageActuelle}/${Math.ceil(TRAFIC_FILTRE.length/lignesParPage)||1}`);
            const pInput = document.getElementById('pageInput');
            if(pInput) { pInput.value = pageActuelle; pInput.max = Math.ceil(TRAFIC_FILTRE.length/lignesParPage)||1; }
            safeSetText('totalPages', "/ " + (Math.ceil(TRAFIC_FILTRE.length/lignesParPage)||1));

            if(data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='9' style='text-align:center; padding:20px; color:#666;'>Aucun paquet trouv√©.</td></tr>";
                return;
            }

            data.forEach((r, idx) => {
                const tr = document.createElement('tr');
                let cls = 'badge-other';
                if(r.proto === 'HTTP') cls = 'badge-http';
                else if(r.proto === 'HTTPS') cls = 'badge-https';
                else if(r.proto === 'TCP') cls = 'badge-tcp';
                else if(r.proto === 'UDP') cls = 'badge-udp';
                else if(r.proto === 'DNS') cls = 'badge-dns';

                let serviceAff = r.service;
                if (!serviceAff || serviceAff === '-' || serviceAff === 'Autre') {
                    if (r.layers) {
                        if (r.layers.tcp && r.layers.tcp["tcp.dstport"]) serviceAff = "Port " + r.layers.tcp["tcp.dstport"];
                        else if (r.layers.udp && r.layers.udp["udp.dstport"]) serviceAff = "Port " + r.layers.udp["udp.dstport"];
                    }
                }
                if(!serviceAff || serviceAff === '-') serviceAff = '<span style="opacity:0.5">-</span>';
                let vendorAff = r.vendor || '<span style="opacity:0.5; font-style:italic;">Inconnu</span>';
                let macAff = r.mac || '<span style="opacity:0.5">-</span>';

                if(r.proto === 'HTTP' && r.info && r.info.includes('POST')) {
                    tr.style.backgroundColor = "rgba(230, 126, 34, 0.2)";
                    tr.style.borderLeft = "3px solid #e67e22";
                }

                tr.innerHTML = `
                    <td style="text-align:center;"><button onclick="inspect(${start+idx})" class="btn-outline" style="border:none; padding:5px;">üîç</button></td>
                    <td class="time-cell">${r.heure||'--'}</td>
                    <td style="color:#fff;">${serviceAff}</td>
                    <td style="font-weight:bold; color:var(--accent-cyan);">${r.src}</td>
                    <td style="font-family:monospace; color:#888; font-size:11px;">${macAff}</td>
                    <td style="color:#ddd;">${vendorAff}</td>
                    <td>${r.dst}</td><td><span class="badge ${cls}">${r.proto}</span></td>
                    <td style="color:var(--text-muted); font-size:12px;">${(r.info||'').substring(0,40)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function inspect(idx) {
            const p = TRAFIC_FILTRE[idx];
            if(!p || !p.layers) { alert("D√©tails non disponibles."); return; }
            const box = document.getElementById('modalContent');
            if(box) {
                box.innerHTML = "";
                const tree = (obj) => {
                    let html = "<div style='margin-left:10px; border-left:1px solid #333; padding-left:5px;'>";
                    for(let k in obj) {
                        let v = obj[k];
                        if(typeof v === 'object' && v!==null) html += `<div><span style='color:#888'>${k}:</span> ${tree(v)}</div>`;
                        else html += `<div><span style='color:#888'>${k}:</span> <span style='color:#fff'>${v}</span></div>`;
                    }
                    return html + "</div>";
                };
                const l = p.layers;
                const secs = { "PHYSIQUE": l.frame, "LIAISON": l.eth||l.wlan, "R√âSEAU": l.ip||l.ipv6, "TRANSPORT": l.tcp||l.udp, "APP": l.http||l.dns||l.tls };
                for(let name in secs) if(secs[name]) box.innerHTML += `<h4 style='background:#1c2128; padding:5px; margin-top:10px;'>${name}</h4>${tree(secs[name])}`;
            }
            document.getElementById('detailModal').style.display='block';
        }

        async function envoyerVersN8N(silent=false) {
            const urlEl = document.getElementById('n8nWebhookUrl');
            if(!urlEl) return;
            const url = urlEl.value;
            if(!url) { if(!silent) alert("URL Webhook vide"); return; }
            try { await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tool:"NETSCOPE", score:document.getElementById('scoreDisplay').innerText, data:TOUT_LE_TRAFIC.slice(0,50)}) });
            if(!silent) alert("Envoy√© !"); } catch(e){ if(!silent) alert("Erreur envoi"); }
        }

        function genererRapportPDF() {
            const scoreText = document.getElementById('scoreDisplay').innerText;
            const logoEl = document.getElementById('mainLogo');
            const logoSrc = logoEl ? logoEl.src : "";
            const dateAudit = new Date().toLocaleString();
            
            let ipCounts={}, svcCounts={};
            const total = TRAFIC_FILTRE.length;
            TRAFIC_FILTRE.forEach(p => {
                ipCounts[p.src] = (ipCounts[p.src]||0)+1;
                let s = p.service && p.service!=='-' ? p.service : p.proto;
                svcCounts[s] = (svcCounts[s]||0)+1;
            });
            const topSrc = Object.entries(ipCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const topSvc = Object.entries(svcCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const alerts = Array.from(document.querySelectorAll('#listeAlertes div')).map(l=>l.innerText).join('<br>');
            
            const html = `<!DOCTYPE html><html><head><title>Rapport</title>
            <style>@page{size:A4 landscape;margin:1cm;} body{font-family:sans-serif;padding:20px;font-size:11px;} table{width:100%;border-collapse:collapse;margin-top:10px;} td,th{border:1px solid #ccc;padding:5px;} th{background:#eee;} .head{display:flex;justify-content:space-between;border-bottom:3px solid #00f2ea;margin-bottom:20px;} .bar{background:#00f2ea;height:5px;}</style>
            </head><body>
            <div class="head"><img src="${logoSrc}" height="50"><div><h1>RAPPORT DE SYNTH√àSE</h1><p>${new Date().toLocaleString()}</p></div></div>
            <div style="background:#00f2ea; padding:15px; text-align:center; margin-bottom:20px;">
                <div style="font-size:24px; font-weight:bold;">SCORE: ${scoreText}</div>
                <div>${TRAFIC_FILTRE.length} Paquets Analys√©s</div>
            </div>
            ${alerts ? `<div style="background:#fff3cd; padding:10px; border:1px solid orange;">${alerts}</div>` : ''}
            <div style="display:flex; gap:20px; margin-top:30px;">
                <div style="flex:1"><h4>TOP TALKERS (IP)</h4><table><thead><tr><th>Source</th><th>Paquets</th></tr></thead><tbody>${topSrc.map(([k,v]) => `<tr><td>${k}</td><td>${v} (${((v/total)*100).toFixed(1)}%)</td></tr>`).join('')}</tbody></table></div>
                <div style="flex:1"><h4>TOP SERVICES</h4><table><thead><tr><th>Service</th><th>Paquets</th></tr></thead><tbody>${topSvc.map(([k,v]) => `<tr><td>${k}</td><td>${v} (${((v/total)*100).toFixed(1)}%)</td></tr>`).join('')}</tbody></table></div>
            </div>
            <div style="margin-top:30px; padding:15px; border:1px solid #ccc;"><h4>RECOMMANDATIONS AUTOMATIQUES</h4><ul><li>Si le score est faible, v√©rifiez les alertes ci-dessus.</li><li>Les adresses IP inconnues dans le "Top Talkers" doivent √™tre investigu√©es.</li><li>Assurez-vous que les flux critiques (Admin) passent par SSH/HTTPS et non HTTP/Telnet.</li></ul></div>
            <script>window.onload=()=>{ setTimeout(()=>window.print(), 500); }<\/script></body></html>`;
            const w = window.open('','_blank'); w.document.write(html); w.document.close();
        }
    </script>
</body>
</html>